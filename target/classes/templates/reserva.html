<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Corte - Barbería</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .booking-form {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .service-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .service-card.selected {
            border: 2px solid #0d6efd;
            transform: translateY(-5px);
        }
        .barber-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .barber-card.selected {
            border: 2px solid #0d6efd;
            transform: translateY(-5px);
        }
        .time-slot {
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            text-align: center;
            display: inline-block;
            width: 80px;
        }
        .time-slot:hover {
            background-color: #f8f9fa;
        }
        .time-slot.selected {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .date-selector {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .date-item {
            cursor: pointer;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            margin: 5px;
            transition: all 0.2s;
            width: 100px;
        }
        .date-item:hover {
            background-color: #f8f9fa;
        }
        .date-item.selected {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .calendar-container {
            margin-bottom: 20px;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Barbería Estilo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reserva">Reservar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reserva/mis-reservas">Mis Reservas</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <!-- Mensaje de éxito después del registro -->
        <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${mensaje}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="booking-form bg-white">
            <div class="form-header">
                <h2>Reserva tu Corte de Cabello</h2>
                <p class="text-muted">Selecciona el servicio, barbero y horario de tu preferencia</p>
            </div>
            
            <form id="reservaForm" th:action="@{/reserva/confirmar}" method="post">
                <!-- Campo oculto para el ID del cliente -->
                <input type="hidden" id="clienteId" name="clienteId" th:value="${clienteId}">
                
                <!-- Paso 1: Seleccionar Corte de Cabello -->
                <div class="booking-step" id="paso1">
                    <h4 class="mb-4">Paso 1: Selecciona tu Corte de Cabello</h4>
                    
                    <div class="row">
                        <div th:each="corte : ${cortes}" class="col-md-4 mb-4">
                            <div class="card service-card h-100" th:data-id="${corte.id}" onclick="seleccionarCorte(this)">
                                <div class="card-body text-center">
                                    <h5 class="card-title" th:text="${corte.nombre}">Nombre del Corte</h5>
                                    <p class="card-text text-primary fw-bold" th:text="'$' + ${corte.precio}">$20.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="corteId" name="corteId">
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-primary" onclick="siguientePaso('paso1', 'paso2')">Siguiente</button>
                    </div>
                </div>
                
                <!-- Paso 2: Seleccionar Barbero -->
                <div class="booking-step" id="paso2" style="display: none;">
                    <h4 class="mb-4">Paso 2: Selecciona tu Barbero</h4>
                    
                    <div class="row">
                        <div th:each="barbero : ${barberos}" class="col-md-4 mb-4">
                            <div class="card barber-card h-100" th:data-id="${barbero.idBarbero}" onclick="seleccionarBarbero(this)">
                                <div class="card-body text-center">
                                    <h5 class="card-title" th:text="${barbero.nombre}">Nombre del Barbero</h5>
                                    <p class="card-text" th:text="${barbero.especialidad}">Especialidad</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="barberoId" name="barberoId">
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="siguientePaso('paso2', 'paso1')">Anterior</button>
                        <button type="button" class="btn btn-primary" onclick="siguientePaso('paso2', 'paso3'); cargarTurnos();">Siguiente</button>
                    </div>
                </div>
                
                <!-- Paso 3: Seleccionar Fecha y Hora -->
                <div class="booking-step" id="paso3" style="display: none;">
                    <h4 class="mb-4">Paso 3: Selecciona Fecha y Hora</h4>
                    
                    <div class="mb-4">
                        <h5>Selecciona una fecha:</h5>
                        <div id="fechasContainer" class="date-selector">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <span class="ms-2">Cargando fechas disponibles...</span>
                        </div>
                        
                        <h5 class="mt-4">Selecciona una hora:</h5>
                        <div id="horasContainer" class="d-flex flex-wrap">
                            <p class="text-center w-100">Selecciona una fecha primero</p>
                        </div>
                    </div>
                    
                    <input type="hidden" id="turnoId" name="turnoId">
                    <input type="hidden" id="fechaSeleccionada" name="fechaSeleccionada">
                    <input type="hidden" id="horaSeleccionada" name="horaSeleccionada">
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="siguientePaso('paso3', 'paso2')">Anterior</button>
                        <button type="button" class="btn btn-primary" onclick="confirmarReserva()">Confirmar Reserva</button>
                    </div>
                </div>
                
                <!-- Paso 4: Resumen y Confirmación -->
                <div class="booking-step" id="paso4" style="display: none;">
                    <h4 class="mb-4">Resumen de tu Reserva</h4>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Corte:</strong> <span id="resumenCorte"></span></p>
                                    <p><strong>Precio:</strong> <span id="resumenPrecio"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Barbero:</strong> <span id="resumenBarbero"></span></p>
                                    <p><strong>Fecha y Hora:</strong> <span id="resumenFechaHora"></span></p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="comentarios" class="form-label">Comentarios adicionales (opcional):</label>
                                <textarea class="form-control" id="comentarios" name="comentarios" rows="3" maxlength="250" placeholder="Escribe aquí cualquier información adicional o petición especial"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="siguientePaso('paso4', 'paso3')">Anterior</button>
                        <button type="submit" class="btn btn-success">Confirmar Reserva</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Barbería Estilo</h5>
                    <p>El mejor lugar para tu corte de cabello y barba.</p>
                </div>
                <div class="col-md-4">
                    <h5>Contacto</h5>
                    <p>Dirección: Av. Principal 123<br>
                    Teléfono: (123) 456-7890<br>
                    Email: info@barberiaestilo.com</p>
                </div>
                <div class="col-md-4">
                    <h5>Horarios</h5>
                    <p>Lunes a Viernes: 9:00 AM - 8:00 PM<br>
                    Sábados: 10:00 AM - 6:00 PM<br>
                    Domingos: Cerrado</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <p>&copy; 2025 Barbería Estilo. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables para almacenar la información seleccionada
        let corteSeleccionado = null;
        let barberoSeleccionado = null;
        let turnoSeleccionado = null;
        let fechaSeleccionada = null;
        let horaSeleccionada = null;
        let turnosPorFecha = {};
        
        // Función para navegar entre pasos
        function siguientePaso(pasoActual, pasoSiguiente) {
            // Validar que se haya seleccionado algo en el paso actual
            if (pasoActual === 'paso1' && !corteSeleccionado) {
                alert('Por favor, selecciona un corte de cabello');
                return;
            }
            
            if (pasoActual === 'paso2' && !barberoSeleccionado) {
                alert('Por favor, selecciona un barbero');
                return;
            }
            
            if (pasoActual === 'paso3' && !turnoSeleccionado && pasoSiguiente === 'paso4') {
                alert('Por favor, selecciona un turno');
                return;
            }
            
            // Ocultar paso actual y mostrar siguiente
            document.getElementById(pasoActual).style.display = 'none';
            document.getElementById(pasoSiguiente).style.display = 'block';
            
            // Si vamos al paso de resumen, actualizar la información
            if (pasoSiguiente === 'paso4') {
                actualizarResumen();
            }
        }
        
        // Función para seleccionar un corte
        function seleccionarCorte(elemento) {
            // Quitar selección anterior
            const servicios = document.querySelectorAll('.service-card');
            servicios.forEach(s => s.classList.remove('selected'));
            
            // Marcar como seleccionado
            elemento.classList.add('selected');
            
            // Guardar ID del corte
            corteSeleccionado = {
                id: elemento.getAttribute('data-id'),
                nombre: elemento.querySelector('.card-title').textContent,
                precio: elemento.querySelector('.card-text').textContent
            };
            
            document.getElementById('corteId').value = corteSeleccionado.id;
        }
        
        // Función para seleccionar un barbero
        function seleccionarBarbero(elemento) {
            // Quitar selección anterior
            const barberos = document.querySelectorAll('.barber-card');
            barberos.forEach(b => b.classList.remove('selected'));
            
            // Marcar como seleccionado
            elemento.classList.add('selected');
            
            // Guardar ID del barbero
            barberoSeleccionado = {
                id: elemento.getAttribute('data-id'),
                nombre: elemento.querySelector('.card-title').textContent
            };
            
            document.getElementById('barberoId').value = barberoSeleccionado.id;
        }
        
        // Función para cargar los turnos disponibles
        function cargarTurnos() {
            if (!barberoSeleccionado) return;
            
            const fechasContainer = document.getElementById('fechasContainer');
            fechasContainer.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="ms-2">Cargando fechas disponibles...</span>
            `;
            
            // Limpiar el contenedor de horas
            document.getElementById('horasContainer').innerHTML = '<p class="text-center w-100">Selecciona una fecha primero</p>';
            
            // Resetear selecciones
            fechaSeleccionada = null;
            horaSeleccionada = null;
            turnoSeleccionado = null;
            
            fetch(`/api/turnos/disponibles/${barberoSeleccionado.id}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`Error del servidor: ${response.status} - ${errorData.error || response.statusText}`);
                        }).catch(e => {
                            throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(turnos => {
                    console.log('Turnos recibidos:', turnos);
                    
                    if (!Array.isArray(turnos) || turnos.length === 0) {
                        fechasContainer.innerHTML = '<p class="text-danger">No hay turnos disponibles para este barbero.</p>';
                        return;
                    }
                    
                    // Agrupar turnos por fecha
                    turnosPorFecha = {};
                    turnos.forEach(turno => {
                        if (turno.fechaHora) {
                            // Usar la fecha exacta del servidor sin ajustes de zona horaria
                            const fechaHora = new Date(turno.fechaHora);
                            // Formatear la fecha en formato ISO (YYYY-MM-DD) para usar como clave
                            const fecha = fechaHora.toISOString().split('T')[0];
                            
                            if (!turnosPorFecha[fecha]) {
                                turnosPorFecha[fecha] = [];
                            }
                            turnosPorFecha[fecha].push(turno);
                        }
                    });
                    
                    // Crear HTML para mostrar las fechas
                    let html = '';
                    
                    for (const fecha in turnosPorFecha) {
                        // Crear objeto Date con la fecha correcta
                        // Usamos new Date(fecha + 'T00:00:00') para asegurar que se interprete en la zona horaria local
                        const fechaObj = new Date(fecha + 'T00:00:00');
                        
                        // Formatear la fecha para mostrar
                        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                            weekday: 'short',
                            day: 'numeric',
                            month: 'short'
                        });
                        
                        html += `
                            <div class="date-item" data-fecha="${fecha}" onclick="seleccionarFecha(this)">
                                ${fechaFormateada}
                            </div>
                        `;
                    }
                    
                    if (html === '') {
                        fechasContainer.innerHTML = '<p class="text-danger">No hay fechas disponibles para este barbero.</p>';
                    } else {
                        fechasContainer.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error al cargar turnos:', error);
                    fechasContainer.innerHTML = `
                        <div class="alert alert-danger">
                            Error al cargar las fechas disponibles: ${error.message}
                        </div>
                        <button type="button" class="btn btn-primary mt-2" onclick="cargarTurnos()">
                            Intentar nuevamente
                        </button>
                    `;
                });
        }
        
        // Función para seleccionar una fecha
        function seleccionarFecha(elemento) {
            // Quitar selección anterior
            const fechas = document.querySelectorAll('.date-item');
            fechas.forEach(f => f.classList.remove('selected'));
            
            // Marcar como seleccionado
            elemento.classList.add('selected');
            
            // Guardar fecha seleccionada
            fechaSeleccionada = elemento.getAttribute('data-fecha');
            document.getElementById('fechaSeleccionada').value = fechaSeleccionada;
            
            // Resetear hora seleccionada
            horaSeleccionada = null;
            turnoSeleccionado = null;
            
            // Cargar horas disponibles para esta fecha
            const horasContainer = document.getElementById('horasContainer');
            
            if (!turnosPorFecha[fechaSeleccionada] || turnosPorFecha[fechaSeleccionada].length === 0) {
                horasContainer.innerHTML = '<p class="text-danger">No hay horarios disponibles para esta fecha.</p>';
                return;
            }
            
            // Ordenar turnos por hora
            const turnosOrdenados = turnosPorFecha[fechaSeleccionada].sort((a, b) => {
                const horaA = a.fechaHora.split('T')[1];
                const horaB = b.fechaHora.split('T')[1];
                return horaA.localeCompare(horaB);
            });
            
            // Crear HTML para mostrar las horas
            let html = '';
            
            turnosOrdenados.forEach(turno => {
                const hora = turno.fechaHora.split('T')[1].substring(0, 5);
                html += `
            <div class="time-slot" 
                 data-id="${turno.idTurno}" 
                 data-hora="${hora}"
                 data-fecha-hora="${turno.fechaHora}"
                 onclick="seleccionarHora(this)">
                ${hora}
            </div>
        `;
            });
            
            horasContainer.innerHTML = html;
        }
        
        // Función para seleccionar una hora
        function seleccionarHora(elemento) {
            // Quitar selección anterior
            const horas = document.querySelectorAll('.time-slot');
            horas.forEach(h => h.classList.remove('selected'));
            
            // Marcar como seleccionado
            elemento.classList.add('selected');
            
            // Guardar información del turno
            turnoSeleccionado = {
                id: elemento.getAttribute('data-id'),
                hora: elemento.getAttribute('data-hora')
            };
            
            horaSeleccionada = turnoSeleccionado.hora;
            
            document.getElementById('turnoId').value = turnoSeleccionado.id;
            document.getElementById('horaSeleccionada').value = horaSeleccionada;
        }
        
        // Función para actualizar el resumen
        function actualizarResumen() {
            document.getElementById('resumenCorte').textContent = corteSeleccionado.nombre;
            document.getElementById('resumenPrecio').textContent = corteSeleccionado.precio;
            document.getElementById('resumenBarbero').textContent = barberoSeleccionado.nombre;
            
            // Formatear la fecha para mostrarla
            // Usamos new Date(fechaSeleccionada + 'T00:00:00') para asegurar que se interprete en la zona horaria local
            const fechaObj = new Date(fechaSeleccionada + 'T00:00:00');
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('resumenFechaHora').textContent = `${fechaFormateada} a las ${horaSeleccionada}`;
        }
        
        // Función para confirmar la reserva
        function confirmarReserva() {
            if (!corteSeleccionado || !barberoSeleccionado || !turnoSeleccionado) {
                alert('Por favor, completa todos los pasos de la reserva');
                return;
            }
            
            siguientePaso('paso3', 'paso4');
        }
        
        // Si hay un ID de cliente en la URL, lo establecemos en el campo oculto
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const clienteId = urlParams.get('clienteId');
            if (clienteId) {
                document.getElementById('clienteId').value = clienteId;
            }
        });
    </script>

    <script>
    // Evita envíos múltiples del formulario
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("reservaForm");
        const submitBtn = form.querySelector('button[type="submit"]');
        let enviado = false;

        form.addEventListener("submit", function(e) {
            if (enviado) {
                e.preventDefault(); // Evita segundo envío
                return;
            }
            enviado = true;
            submitBtn.disabled = true; // Desactiva el botón
            submitBtn.textContent = "Procesando..."; // Feedback visual
        });
    });
</script>
</body>
</html>
